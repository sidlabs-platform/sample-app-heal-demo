name: CI Pipeline (Copilot CLI)

on:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        shell: bash
        run: |
          set -o pipefail
          npm run lint 2>&1 | tee ci-output.log

      - name: Test
        shell: bash
        run: |
          set -o pipefail
          npm test 2>&1 | tee -a ci-output.log

      - name: Generate diagnostic JSON
        if: failure()
        run: |
          npm run lint:json || true
          npm run test:json || true

      - name: Upload CI artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-output
          path: |
            ci-output.log
            lint-output.json
            test-results.json

  auto-heal:
    needs: build-and-test
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Download CI artifacts
        uses: actions/download-artifact@v4
        with:
          name: ci-output
        continue-on-error: true

      - name: Re-generate diagnostics
        run: |
          npm run lint:json || true
          npm run test:json || true

      - name: Install Copilot CLI
        run: npm install -g @github/copilot

      - name: Build heal prompt
        id: prompt
        shell: bash
        run: |
          FAILURE_TYPE="unknown"
          FAILURES=""
          CI_LOG_TAIL=""

          # Read CI log tail
          if [ -f ci-output.log ]; then
            CI_LOG_TAIL=$(tail -200 ci-output.log)
          fi

          # Detect lint failures
          if [ -f lint-output.json ]; then
            LINT_ERRORS=$(node -e "
              const r = JSON.parse(require('fs').readFileSync('lint-output.json','utf8'));
              const errs = r.filter(f => f.errorCount > 0).flatMap(f =>
                f.messages.filter(m => m.severity === 2).map(m =>
                  f.filePath.replace(process.cwd()+'/', '') + ':' + m.line + ' ' + m.ruleId + ': ' + m.message
                )
              );
              if (errs.length) { console.log(errs.join('\n')); }
            " 2>/dev/null || true)
            if [ -n "$LINT_ERRORS" ]; then
              FAILURE_TYPE="lint-violation"
              FAILURES="$LINT_ERRORS"
            fi
          fi

          # Detect test failures
          if [ -f test-results.json ]; then
            TEST_ERRORS=$(node -e "
              const r = JSON.parse(require('fs').readFileSync('test-results.json','utf8'));
              if (r.numFailedTests > 0) {
                const fails = r.testResults.flatMap(s =>
                  (s.testResults||[]).filter(t => t.status==='failed').map(t =>
                    t.fullName + ': ' + (t.failureMessages||[]).join(' ').substring(0,500)
                  )
                );
                console.log(fails.join('\n'));
              }
            " 2>/dev/null || true)
            if [ -n "$TEST_ERRORS" ]; then
              if [ "$FAILURE_TYPE" = "unknown" ]; then
                FAILURE_TYPE="test-failure"
              else
                FAILURE_TYPE="${FAILURE_TYPE}+test-failure"
              fi
              FAILURES="${FAILURES}
          ${TEST_ERRORS}"
            fi
          fi

          # Build the prompt and write to file (avoids shell escaping issues)
          cat > /tmp/heal-prompt.txt <<PROMPT_EOF
          You are a CI/CD auto-healer. The CI pipeline failed with a ${FAILURE_TYPE}.

          ## Failure Details
          ${FAILURES}

          ## CI Log (last 200 lines)
          ${CI_LOG_TAIL}

          ## Instructions
          1. Read the failure details above.
          2. Read the relevant source files in the repository.
          3. Fix the root cause with minimal changes.
          4. Only modify files under src/ and tests/.
          5. Do NOT delete or skip tests.
          6. After fixing, verify with: npm run lint && npm test
          PROMPT_EOF

          echo "failure_type=$FAILURE_TYPE" >> "$GITHUB_OUTPUT"
          echo "[heal] Failure type: $FAILURE_TYPE"

      - name: Run Copilot CLI
        shell: bash
        run: |
          mkdir -p .heal-audit
          echo "[heal] Invoking Copilot CLI with --agent=auto-healer..."
          copilot \
            -p "$(cat /tmp/heal-prompt.txt)" \
            --agent=auto-healer \
            --allow-all-tools \
            2>&1 | tee .heal-audit/copilot-output.log
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Validate fix
        id: validate
        shell: bash
        run: |
          echo "[heal] Validating fix..."
          if npm run lint && npm test; then
            echo "[heal] Validation PASSED"
            echo "valid=true" >> "$GITHUB_OUTPUT"
          else
            echo "[heal] Validation FAILED"
            echo "valid=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create fix PR
        if: steps.validate.outputs.valid == 'true'
        shell: bash
        run: |
          BRANCH="auto-heal/copilot-cli-$(date +%s)"
          git config user.name "auto-heal-bot"
          git config user.email "auto-heal-bot@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add src/ tests/
          if git diff --cached --quiet; then
            echo "[heal] No changes to commit"
            exit 0
          fi
          FAILURE_TYPE="${{ steps.prompt.outputs.failure_type }}"
          git commit -m "fix(auto-heal): ${FAILURE_TYPE} (copilot-cli)"
          git push origin "$BRANCH"
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "Auto-heal: fix ${FAILURE_TYPE}" \
            --body "## Auto-Heal Fix (Copilot CLI)

          **Failure type:** ${{ steps.prompt.outputs.failure_type }}
          **Validation:** Passed (lint + tests)

          ---
          *Created automatically by the self-healing CI pipeline using GitHub Copilot CLI.*"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Report failure
        if: steps.validate.outputs.valid != 'true'
        run: |
          echo "::error::Auto-heal fix did not pass validation. Manual intervention required."
          exit 1

      - name: Upload heal audit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: heal-audit
          path: .heal-audit/
          retention-days: 30
